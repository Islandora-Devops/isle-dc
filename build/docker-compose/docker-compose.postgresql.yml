version: "3.7"
networks:
  default:
    internal: true
volumes:
  postgresql-data:
services:
  # This exists side by side with the 'mariadb' service. This is because
  # Matomo doesn't support PostgreSQL so if we adopt it we still need to have a
  # MySQL as well.
  #
  # Additionally the defaults need to change on services which use PostgreSQL.
  # For those services there is docker-compose.SERVICE.postgresql.yml files which
  # are included when the respective 'SERVICENAME_DATABASE_SERVICE' variable is set
  # to 'postgresql'.
  postgresql:
    restart: ${RESTART_POLICY}
    image: ${REPOSITORY}/postgresql:${TAG}
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    # Allows for access to the database through traefik to support using Drush locally.
    # This should not be used in production.
    #
    # Since this is not http, but tcp traffic it does does not understand the concept of a "host".
    # so we must dedicate a port to it in traefik, and direct all traffic to this router: HostSNI(`*`).
    labels:
      - traefik.enable=${EXPOSE_POSTGRES:-false}
      - traefik.tcp.services.${COMPOSE_PROJECT_NAME}-postgresql.loadbalancer.server.port=5432
      - traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-postgresql_tcp.service=${COMPOSE_PROJECT_NAME}-postgresql
      - traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-postgresql_tcp.entrypoints=postgresql
      - traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-postgresql_tcp.rule=HostSNI(`*`)
    networks:
      default:
