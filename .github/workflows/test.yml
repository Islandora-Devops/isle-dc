name: Test
on:
  push:
    paths-ignore:
      - '**/*.md'
  schedule:
    # UTC
    - cron: '15 12 * * *'
env:
  TERM: xterm-256color
jobs:
  make:
    permissions:
      contents: read
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # TODO: keep an eye when macos-14+ (M1) docker support is available
        os: [windows-latest, ubuntu-latest]
    steps:
      - name: make build
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          # we obviously don't want to do this here, just want to see if it builds
          printenv
          mkdir -p "/c/Users/runneradmin/.docker/cli-plugins"
          export PATH="$PATH:/c/Users/runneradmin/.docker/cli-plugins"
          curl -s "https://github.com/docker/buildx/releases/download/v0.14.0/buildx-v0.14.0.windows-amd64.exe" -o "/c/Users/runneradmin/.docker/cli-plugins/docker-buildx.exe"
          ls -l /c/Users/runneradmin/.docker/cli-plugins
          git clone https://github.com/Islandora-Devops/isle-buildkit /tmp/ibk
          cd /tmp/ibk
          make bake TAGS=3.2.1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: init secrets
        run: |-
          cp sample.env .env
          ./build/scripts/check-secrets.sh yes
        shell: bash

      - name: make starter
        run: make starter
        shell: bash

      - name: check online
        shell: bash
        run: |-
          STATUS=$(curl -k \
            -w '%{http_code}' -o /dev/null \
            https://islandora.traefik.me/)
          echo "Site check returned ${STATUS}"
          if [ ${STATUS} -ne 200 ]; then
            echo "Failed to bring up site"
            exit 1
          fi

      - name: make build
        run: make build
        shell: bash

      - name: make production
        run: make production
        shell: bash

      - name: check online
        shell: bash
        run: |-
          STATUS=$(curl -k \
            -w '%{http_code}' -o /dev/null \
            https://islandora.traefik.me/)
          echo "Site check returned ${STATUS}"
          if [ ${STATUS} -ne 200 ]; then
            echo "Failed to bring up site"
            exit 1
          fi

      - name: Notify Slack on nightly test failure
        shell: bash
        if: failure() && github.event_name == 'schedule'
        run: |-
          curl -s -o /dev/null -XPOST $SLACK_WEBHOOK_URL -d '{
            "text": "ðŸš¨ Scheduled job failed! Click to view the run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Run>",
          }'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
